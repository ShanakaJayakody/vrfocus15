<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAT VR Practice - MedwithPurpose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f2f5; /* Light background like UCAT */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2rem); /* Full height minus padding */
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* Border like UCAT */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.375rem; /* Slightly rounded corners */
            margin: 1rem; /* Add some margin */
            overflow: hidden; /* Prevent content overflow from container */
        }
        /* Header and Footer */
        .header-bar, .footer-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: #006DAA; /* Updated background color */
            color: white; /* Set default text color to white */
            padding: 0.75rem 1.5rem; /* Padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Specific text colors within header/footer */
        .header-bar span, .header-bar div {
             color: white;
        }
        #timer {
             background-color: rgba(255, 255, 255, 0.2); /* Lighter background for timer */
             color: white;
             font-weight: bold;
             padding: 0.25rem 0.75rem; /* Adjusted padding */
             border-radius: 0.25rem; /* Slightly rounded */
        }
         /* Footer Button Styling */
        .footer-bar button {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Subtle white border */
            padding: 0.4rem 0.8rem; /* Adjust padding */
            font-size: 0.8rem; /* Adjust font size */
            border-radius: 0.375rem;
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .footer-bar button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.15); /* Slight white background on hover */
            border-color: white;
        }
         .footer-bar button:disabled {
             opacity: 0.5;
             cursor: not-allowed;
             border-color: rgba(255, 255, 255, 0.3);
         }
         /* Keep primary button distinct */
         .footer-bar button#next-button {
             background-color: #ffffff; /* White background */
             color: #006DAA; /* Blue text */
             border: 1px solid white;
             font-weight: 500;
         }
         .footer-bar button#next-button:hover:not(:disabled) {
             background-color: #f0f0f0; /* Slightly off-white on hover */
         }
         /* Flag button specific style */
         #flag-button {
             background-color: transparent;
             border: 1px solid white;
             color: white;
             transition: background-color 0.2s ease, color 0.2s ease; /* Add transition */
         }
         #flag-button:hover {
             background-color: white;
             color: #006DAA;
         }
         /* Style for when a question IS flagged */
          #flag-button.flagged {
             background-color: #facc15; /* Yellow-400 */
             border-color: #facc15;
             color: #422006; /* Dark brown text for contrast */
          }
          #flag-button.flagged:hover {
             background-color: #f59e0b; /* Amber-500 */
             border-color: #f59e0b;
          }


        /* Main Content Area */
        .main-content-area {
            flex-grow: 1; /* Take remaining vertical space */
            display: flex;
            overflow: hidden; /* Prevent content overflow issues */
            padding: 1rem; /* Padding around passage/question */
            gap: 1rem; /* Gap between passage and question */
        }
        /* Passage and Question Columns */
        .passage-column {
            flex: 0 0 60%; /* Set passage width to 60% */
            overflow-y: auto; /* Allow vertical scrolling */
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background-color: #f9fafb; /* Slight background tint */
            height: 100%; /* Fill available height */
        }
        .question-column {
             flex: 0 0 40%; /* Set question width to 40% */
             overflow-y: auto; /* Allow vertical scrolling */
             padding: 1rem;
             border: 1px solid #e5e7eb;
             border-radius: 0.375rem;
             background-color: #f9fafb; /* Slight background tint */
             height: 100%; /* Fill available height */
             position: relative; /* Needed for absolute positioning if used later */
        }

        /* Style for selected answer */
        .selected-answer {
            background-color: #bfdbfe !important; /* Tailwind blue-200 - use !important to override hover */
            border-color: #3b82f6 !important; /* Tailwind blue-500 */
        }
        /* Style for navigator buttons */
        .nav-answered {
            background-color: #a7f3d0; /* Tailwind emerald-200 */
        }
        .nav-current {
            border: 2px solid #3b82f6 !important; /* Tailwind blue-500 */
            font-weight: bold;
        }
        /* Style for flagged questions in navigator/review */
        .nav-flagged, .review-flagged {
            border: 2px solid #f59e0b !important; /* Amber-500 border */
            position: relative; /* Needed for potential icon positioning */
        }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 0.5rem; }
        .modal.flex { display: flex; }

        /* General Button Styling (outside footer) */
        button, .button {
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        button:active, .button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .primary-button { background-color: #3b82f6; color: white; border: 1px solid transparent; }
        .primary-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: white; color: #374151; border: 1px solid #d1d5db; }
        .secondary-button:hover:not(:disabled) { background-color: #f9fafb; }
        .danger-button { background-color: #ef4444; color: white; border: 1px solid transparent; }
        .danger-button:hover:not(:disabled) { background-color: #dc2626; }
        .subtle-button { background-color: #f3f4f6; color: #374151; border: 1px solid transparent; }
        .subtle-button:hover:not(:disabled) { background-color: #e5e7eb; }


        /* Styling for radio button labels to act as buttons */
        .option-label {
            display: block;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            background-color: #ffffff; /* White background for options */
        }
        .option-label:hover:not(.selected-answer) { /* Prevent hover style if selected */
            background-color: #f3f4f6; /* Tailwind gray-100 */
            border-color: #a5b4fc; /* Indigo-300 on hover */
        }
        /* Hide actual radio buttons */
        input[type="radio"] { display: none; }

        /* --- Result Styling --- */
        /* Result highlighting for list items (kept for PDF or future use) */
       .correct-answer-li { background-color: #dcfce7; border-left: 4px solid #22c55e; }
       .incorrect-answer-li { background-color: #fee2e2; border-left: 4px solid #ef4444; }
       .result-item-clickable-li { /* Suffix -li to distinguish from new box style */
           cursor: pointer;
           transition: background-color 0.2s ease-in-out;
           border: 1px solid #e5e7eb;
           border-radius: 0.5rem;
           margin-bottom: 0.5rem;
           padding: 0.75rem;
       }
       .result-item-clickable-li:hover {
           background-color: #f0f0f0;
       }
       .correct-indicator-text { color: #16a34a; font-weight: 600;}
       .incorrect-indicator-text { color: #dc2626; font-weight: 600;}

        /* NEW Result Box Grid Styling */
        #results-grid-container { /* Container for the new grid */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Responsive grid */
            gap: 1rem; /* Gap between boxes */
            padding: 1rem 0; /* Padding around the grid */
            overflow-y: auto; /* Allow scrolling if many items */
            max-height: 30vh; /* Limit height to encourage scrolling for many items */
        }
        .result-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 0.5rem; /* Adjusted padding */
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 70px; /* Ensure a minimum height */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .result-box-correct {
            background-color: #22c55e; /* Tailwind green-500 */
            border: 1px solid #16a34a; /* Tailwind green-700 */
        }
        .result-box-incorrect {
            background-color: #ef4444; /* Tailwind red-500 */
            border: 1px solid #dc2626; /* Tailwind red-600 */
        }
        .result-box-flagged { /* Optional: style for flagged questions in grid */
            outline: 2px solid #f59e0b; /* Amber-500 outline */
            outline-offset: 2px;
        }
        .result-box .time-spent {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            line-height: 1.1;
        }
        .result-box .question-num-label {
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem; /* mt-1 */
            line-height: 1;
        }
       /* --- END Result Styling --- */

         /* Style for explanation box (used in results and review view) */
         .explanation-box {
             background-color: #fef3c7; /* Tailwind amber-100 */
             border: 1px solid #fcd34d; /* Tailwind amber-300 */
             padding: 0.5rem 0.75rem; /* p-2 equivalent */
             margin-top: 0.75rem; /* mt-3 */
             border-radius: 0.375rem; /* rounded-md */
             font-size: 0.875rem; /* text-sm */
             color: #78350f; /* Tailwind amber-900 */
         }

         /* Review Grid Button Styles */
         .review-grid-button {
             padding: 0.5rem 0.25rem; /* Adjust padding */
             border: 1px solid #d1d5db; /* Default border */
             border-radius: 0.375rem;
             text-align: center;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             font-size: 0.875rem;
             line-height: 1.25rem;
             cursor: pointer;
         }
         .review-grid-button-answered {
             background-color: #dcfce7; /* Lighter green */
             border-color: #86efac; /* Green border */
             color: #15803d; /* Darker green text */
         }
         .review-grid-button-unanswered {
             background-color: #f3f4f6; /* Light gray */
             border-color: #d1d5db; /* Gray border */
             color: #4b5563; /* Gray text */
         }
          .review-grid-button:hover {
             filter: brightness(95%); /* Slightly darken on hover */
          }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-container {
                 height: auto; /* Allow height to adjust */
                 margin: 0.5rem;
            }
            .main-content-area {
                flex-direction: column; /* Stack columns */
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .passage-column, .question-column {
                flex-basis: auto;
                width: 100%; 
                height: auto; 
                max-height: 40vh; 
                padding: 0.75rem;
            }
            .header-bar, .footer-bar {
                padding: 0.5rem 1rem;
            }
            .header-bar span, .footer-bar button { 
                font-size: 0.8rem;
            }
            button, .button {
                padding: 0.4rem 0.8rem;
            }
             .footer-bar button {
                 padding: 0.3rem 0.6rem;
                 font-size: 0.75rem;
             }
            .grid-cols-5 { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
            #review-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } 
            .review-grid-button { font-size: 0.8rem; }
            #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); } /* Adjust grid for smaller screens */
        }
         @media (max-width: 480px) {
             .grid-cols-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); } 
             #review-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } 
             .header-bar span, .footer-bar button { font-size: 0.75rem; }
             button, .button {
                 padding: 0.3rem 0.6rem;
             }
              .footer-bar button {
                 padding: 0.25rem 0.5rem;
                 font-size: 0.7rem;
             }
             .option-label { padding: 0.5rem 0.75rem; font-size: 0.8rem;}
             .review-grid-button { font-size: 0.75rem; }
             #results-grid-container { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); } /* Further adjust grid */
             .result-box .time-spent { font-size: 1rem; }
             .result-box .question-num-label { font-size: 0.65rem; }
         }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    </head>
<body>

    <div id="app-container">

        <div id="setup-screen" class="p-6 md:p-8 flex flex-col justify-center items-center h-full">
             <div class="text-center mb-6">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-20 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                <h1 class="text-2xl md:text-3xl font-bold text-blue-600">UCAT Verbal Reasoning Practice</h1>
                <p class="text-gray-600 mt-2">Prepare for the UCAT VR section.</p>
                 <p class="text-sm text-gray-500 mt-4">
                     This section contains <strong id="setup-question-count">16 questions</strong> and you have <strong id="setup-time-limit">10 minutes</strong> to complete it.
                 </p>
            </div>
            <div class="space-y-4 w-full max-w-md">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name:</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Enter your name">
                </div>
                <div>
                    <label for="goal" class="block text-sm font-medium text-gray-700">Goal (Score out of 16):</label>
                    <input type="number" id="goal" name="goal" min="0" max="16" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., 12">
                </div>
                <div>
                    <label for="focus-area" class="block text-sm font-medium text-gray-700">Area of Focus / Intention For Practice:</label>
                    <input type="text" id="focus-area" name="focus-area" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., True/False/Can't Tell, Speed">
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="start-button" class="primary-button text-lg px-8 py-3">
                    Start Exam
                </button>
            </div>
        </div>

        <div id="exam-screen" class="hidden flex flex-col h-full">
            <div class="header-bar">
                <span id="exam-title" class="font-semibold">Verbal Reasoning</span>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="text-base px-3 py-1 rounded-md">10:00</div>
                    <span class="text-sm">Question <span id="question-number-info">1</span> of 16</span>
                    <button id="flag-button" class="text-sm font-medium border border-white rounded px-2 py-1 transition-colors duration-150">
                         Flag for Review
                    </button>
                </div>
            </div>

            <div class="main-content-area">
                <div class="passage-column">
                    <h3 class="text-lg font-semibold mb-2 sticky top-0 bg-gray-50 pb-1">Passage <span id="passage-number">1</span></h3>
                    <div id="passage-text" class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">
                        </div>
                </div>

                <div class="question-column">
                    <h4 class="text-md font-semibold mb-3 sticky top-0 bg-gray-50 pb-1">Question <span id="question-number">1</span></h4>
                    <p id="question-text" class="mb-4 text-gray-800">
                        </p>
                    <div id="options-container" class="space-y-2">
                        </div>
                    <div id="review-explanation-container"></div>
                </div>
            </div>

            <div class="footer-bar">
                 <button id="back-to-results-button" class="hidden mr-auto">← Back to Results</button>
                 <button id="end-exam-button-footer">End Exam</button>
                 <div class="flex items-center space-x-2 ml-auto">
                     <button id="prev-button" disabled>← Previous (Alt+P)</button>
                     <button id="navigator-button">Navigator</button>
                     <button id="next-button">Next (Alt+N) →</button>
                 </div>
            </div>
        </div>

        <div id="review-screen" class="hidden p-6 md:p-8 flex flex-col items-center h-full overflow-y-auto">
             <div class="w-full max-w-3xl mb-4 flex justify-between items-center">
                 <h2 class="text-2xl font-bold text-blue-600">Review Your Answers</h2>
                 <button id="filter-flagged-button" class="secondary-button text-sm">Show Flagged Only</button>
             </div>
             <p class="text-center text-gray-600 mb-6">Click on a question number to review it. Green indicates answered, Yellow border indicates flagged.</p>
            <div id="review-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-10 gap-3 mb-6 w-full max-w-3xl">
                </div>
            <div class="mt-auto pt-6">
                <button id="end-exam-button" class="danger-button text-lg px-8 py-3">
                    End Exam & See Results
                </button>
            </div>
        </div>

        <div id="results-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
             <div class="text-center mb-6 flex-shrink-0">
                <img src="https://ik.imagekit.io/mwp/MWP%20Color%20no%20background.png?updatedAt=1745982959141"
                     alt="MedwithPurpose Logo"
                     class="mx-auto h-16 w-auto mb-4"
                     onerror="this.style.display='none'; this.onerror=null;">
                 <h2 class="text-2xl md:text-3xl font-bold text-blue-600">Exam Results</h2>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center flex-shrink-0">
                 <p class="text-lg font-semibold">Your Score: <span id="score" class="text-blue-700">0</span> / <span id="total-questions-results">16</span></p>
                 <p class="text-gray-600">Time Taken: <span id="time-taken"></span></p>
            </div>
            <h3 class="text-xl font-semibold mb-2 flex-shrink-0">Detailed Results:</h3>
            <p class="text-sm text-gray-500 mb-4 flex-shrink-0">Click on a question box below to review it.</p>
            <div id="results-grid-container" class="flex-grow">
                </div>
            <div class="mt-6 flex-shrink-0 border-t pt-4">
                 <div class="mb-4">
                    <label for="focus-rating" class="block text-md font-semibold text-gray-700 mb-1">My focus out of 5 (1 very low, 5 very high):</label>
                    <input type="number" id="focus-rating" name="focus-rating" min="1" max="5" class="mt-1 block w-20 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1-5">
                 </div>
                 <div>
                    <label for="reflection-text" class="block text-md font-semibold text-gray-700 mb-1">Main takeaway from this practice:</label>
                    <textarea id="reflection-text" name="reflection-text" rows="3" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Reflect on your performance, strategies, or areas for improvement..."></textarea>
                 </div>
            </div>
             <div class="mt-6 text-center flex-shrink-0 flex justify-center space-x-4">
                <button onclick="window.location.reload()" class="secondary-button px-6 py-2">
                    Try Again
                </button>
                <button id="download-pdf-button" class="primary-button px-6 py-2">
                    Download Results PDF
                </button>
            </div>
        </div>

        <div id="navigator-modal" class="modal">
            <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Question Navigator</h3>
                    <button id="close-modal-button" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mb-4">Click a number to jump. Green: answered, Yellow border: flagged.</p>
                <div id="navigator-grid" class="grid grid-cols-5 gap-3">
                    </div>
            </div>
        </div>

    </div>

    <script>
        // --- Data ---
        // Updated Passages from VR Focus Group #15.pdf
        const passages = [
            // Passage 1: The Year Without a Summer
            `The year 1816 is remembered by climatologists and historians alike as "The Year Without a Summer." Unseasonal weather patterns devastated harvests across the Northern Hemisphere, leading to widespread food shortages, price spikes, and civil unrest. Though initially inexplicable, the cause was eventually traced to the 1815 eruption of Mount Tambora in present-day Indonesia-one of the most powerful volcanic eruptions in recorded history. The eruption released vast amounts of sulphur dioxide into the stratosphere, creating a global haze that significantly reduced sunlight and lowered surface temperatures.\nIn North America and parts of Europe, snow fell in June, and frosts persisted into July. Crops failed en masse in countries like Ireland, where the potato crop was hit particularly hard, and in Switzerland, where famine conditions contributed to spikes in mortality. Notably, it was during this enforced indoor confinement at Lake Geneva that Mary Shelley began writing what would become Frankenstein, a detail often cited to show the indirect cultural impact of climatic anomalies.\nThe longer-term consequences of the 1816 disruption are harder to trace but potentially profound. Some economic historians suggest that the subsequent migration waves from Europe to the Americas-particularly between 1817 and 1821-were partly triggered by the lingering economic fallout of that failed agricultural year. Others caution that such inferences may conflate correlation with causation, given the already complex political and social factors at play following the Napoleonic Wars.`,
            // Passage 2: Bicycle Stability
            `The stability of a moving bicycle has traditionally been attributed to the gyroscopic effect-the resistance to directional change caused by the spinning wheels. When a rider leans, the angular momentum of the front wheel generates a corrective steering force (called gyroscopic precession) that turns the wheel in the direction of the lean, helping bring the bike back under the rider's centre of mass. This effect increases with speed, which is why moving bikes are easier to balance than stationary ones.\nHowever, in 2011, researchers constructed a custom bicycle with counter-rotating wheels, designed to cancel out the gyroscopic effect entirely. Surprisingly, the bike remained upright without a rider, provided it was rolling forward. This finding shifted attention toward another stabilising factor: trail. Trail refers to the distance by which the contact point of the front wheel falls behind the steering axis. Like a shopping trolley's front wheels, this offset causes the front wheel to automatically steer into the direction of a fall, restoring balance.\nWhile some early models suggested gyroscopic forces were sufficient for balance, modern understanding recognises that, while geometry is the most crucial factor, stability is not the result of any single mechanism. Geometry, mass distribution, speed, and even frame stiffness interact in complex ways. Among these, trail has gained renewed importance-though researchers still emphasise that no one variable tells the full story.`,
            // Passage 3: Medieval Drawbridges
            `Medieval castles often relied on drawbridges to defend their entrances. These drawbridges were typically raised and lowered by a system of pulleys and counterweights-a rudimentary but effective form of mechanical advantage. In some designs, the counterweight was fixed and buried underground in a pit below the winch housing, acting as a passive force against the pull of gravity. Others used movable stone blocks suspended from chains, allowing fine adjustments depending on the weight of the bridge or additional loads, such as carts or cavalry.\nThe engineering behind these systems allowed a relatively small team-sometimes just two individuals to lift bridges weighing upwards of a ton. Contemporary reconstructions suggest that the inclusion of counterweights reduced the effective load by as much as 75%, greatly extending the operational lifespan of the bridge's hinges and axles. However, documents from the 14th century also record failures of these systems due to war damage, poor weather, and rope degradation.\nInterestingly, the psychological impact of drawbridges was often as important as their physical function. Chronicles from the period describe attackers hesitating at the sight of a raised drawbridge, associating it with an unbreachable fortress, even when the rest of the defenses were modest. This perception may have exaggerated the military effectiveness of the mechanism far beyond its actual strength.`,
            // Passage 4: Gendered and Sexual Violence Rallies
            `Tens of thousands of men, women and children have marched across Australian capital cities and regional towns calling for determined action to end gendered and sexual violence.\nAdvocates say the issue was not properly addressed during the federal election campaign, with funding pledges "barely even hitting the sides". The No More: National Rally Against Violence saw attendees gather in Sydney, Melbourne, Brisbane, Perth, Adelaide, Canberra, Hobart and regional centres in between. Organiser Sarah Williams called for more funding, training, and law reform to combat violence.\n"We need to be able to stop it before it starts," she told a 2,000-strong crowd on the steps of Parliament House in Melbourne on Saturday.\n"We need more funding for primary prevention, more trauma-informed response training for police, increased crisis housing, bail law reform and uniform consent laws," she said. "Men listen to men we need more male role models out there," Williams said.\nConsent and healthy relationship education should be expanded to more schools with additional funding, and community sporting clubs and major codes could also play a role in reaching different generations, she said. A total of 128 women have been killed since January 2024, according to the Australian Femicide Watch website. It has also pledged to invest more funding to stop high-risk perpetrators through electronic monitoring.\nBut Moody said ministers and leaders needed to sit down with frontline services to figure out what works.\nSource:https://www.sbs.com.au/news/article/rallies-against-gendered-and-sexual-violence-held-across-australia/rxhvn3han`
        ];

        // Updated Questions (16 total) from VR Focus Group #15.pdf
        const questions = [
            // Passage 1 Questions
            { passageIndex: 0, text: "The author would most likely agree that the cultural impact of the 1816 climate anomaly was:", options: ["limited to the region most directly affected by Tambora's eruption.", "one of the few long-lasting effects of the volcanic eruption.", "made possible only because of extreme weather confinement.", "an indirect but noteworthy consequence of environmental disruption."], correctAnswer: "D", explanation: "The correct answer is D. The passage mentions Mary Shelley's Frankenstein as an 'indirect cultural impact,' supporting the idea of noteworthy, indirect consequences of environmental disruption." },
            { passageIndex: 0, text: "Which of the following best describes the author's view on the link between climate events and migration?", options: ["Clear evidence shows that major climate disruptions drive long-term migration trends.", "While the theory is plausible, it remains open to debate due to overlapping historical factors.", "There is little evidence that migration patterns were influenced by environmental causes.", "Most economic historians believe that failed harvests were the sole driver of post-war migration."], correctAnswer: "B", explanation: "The correct answer is B. The passage presents the idea of migration linked to the failed harvest but also includes the caution that 'Others caution that such inferences may conflate correlation with causation, given the already complex political and social factors at play,' indicating the link is plausible but debatable." },
            { passageIndex: 0, text: "What can most reasonably be inferred about the author's broader attitude toward historical interpretation?", options: ["They see value in linking cultural works to historical moments but caution against simplistic narratives.", "They believe history should focus only on measurable outcomes like death tolls and migrations.", "They see literature as irrelevant to historical causation.", "They consider environmental history more rigorous than political history."], correctAnswer: "A", explanation: "The correct answer is A. The author highlights the cultural impact (Frankenstein) and discusses the complexities of linking the eruption to migration (cautioning against conflating correlation with causation), suggesting an appreciation for nuanced interpretation." },
            { passageIndex: 0, text: "Which of the following, if added to the passage, would most strengthen the author's implication that the Tambora eruption had global consequences?", options: ["A contemporary newspaper report describing cold weather in Indonesia in 1816.", "Evidence that sulfur particles from Tambora were found in Greenland ice cores.", "A study showing that volcanoes can affect weather for several months.", "A statement from a historian linking Tambora to the fall of the Qing dynasty."], correctAnswer: "B", explanation: "The correct answer is B. Finding sulfur particles in Greenland ice cores would provide direct physical evidence of the widespread atmospheric distribution of Tambora's ejecta, strongly supporting its global impact." },
            // Passage 2 Questions
            { passageIndex: 1, text: "Based on the passage, which of the following best explains why the gyroscopic effect becomes more noticeable at higher speeds?", options: ["The spinning wheel begins to act like a stabilizer bar.", "Faster rotation increases angular momentum, making the stabilizing force stronger.", "The rider applies more corrective balance as they ride faster.", "The bicycle's geometry becomes less important at higher velocities."], correctAnswer: "B", explanation: "The correct answer is B. The passage states, 'When a rider leans, the angular momentum of the front wheel generates a corrective steering force... This effect increases with speed.' Angular momentum is directly related to the speed of rotation." },
            { passageIndex: 1, text: "What can be inferred about the significance of the 2011 counter-rotating wheel experiment?", options: ["It proved that rider balance is unnecessary for bicycle stability.", "It demonstrated that gyroscopic forces are the only contributor to bicycle stability.", "It challenged the assumption that gyroscopic effects are required for self-stability.", "It showed that bicycles without moving wheels can still be stable."], correctAnswer: "C", explanation: "The correct answer is C. The experiment showed a bike with 'counter-rotating wheels, designed to cancel out the gyroscopic effect entirely... remained upright without a rider,' thus challenging the necessity of gyroscopic effects for self-stability." },
            { passageIndex: 1, text: "Which of the following most accurately reflects the author's view on the causes of bicycle stability?", options: ["While trail geometry is a factor, angular momentum is ultimately the primary reason bikes stay upright.", "Geometry is more significant than gyroscopic effects, though neither alone is sufficient.", "Rider skill is the most reliable predictor of whether a bicycle remains stable.", "Stability is entirely a consequence of the wheelbase length and mass distribution."], correctAnswer: "B", explanation: "The correct answer is B. The passage states, 'modern understanding recognises that, while geometry is the most crucial factor, stability is not the result of any single mechanism' and mentions trail (a geometric factor) gained 'renewed importance,' suggesting geometry is key but interacts with other factors." },
            { passageIndex: 1, text: "Which of the following is most consistent with the passage's analogy involving supermarket trolleys?", options: ["Trolley wheels also use angular momentum to resist turning.", "The front wheels of a trolley are heavier to keep it stable.", "Unlike bikes, trolleys rely on the rider's force for balance.", "Both trolleys and bicycles use caster-like designs to self-align their direction."], correctAnswer: "D", explanation: "The correct answer is D. The passage explains trail by comparing it to 'a shopping trolley's front wheels,' where the 'offset causes the front wheel to automatically steer into the direction of a fall, restoring balance.' This describes a caster effect for self-alignment." },
            // Passage 3 Questions
            { passageIndex: 2, text: "In the best-preserved medieval drawbridges, counterweights were always stored underground.", options: ["True", "False", "Can't tell"], correctAnswer: "B", explanation: "The correct answer is False. The passage states, 'In some designs, the counterweight was fixed and buried underground... Others used movable stone blocks suspended from chains,' indicating not all were underground." },
            { passageIndex: 2, text: "Some drawbridges could be operated by just two people because of the mechanical advantage provided by the design.", options: ["True", "False", "Can't tell"], correctAnswer: "A", explanation: "The correct answer is True. The passage explicitly states, 'The engineering behind these systems allowed a relatively small team-sometimes just two individuals to lift bridges weighing upwards of a ton' due to 'mechanical advantage.'" },
            { passageIndex: 2, text: "The inclusion of counterweights made the bridge's axle and hinge systems more susceptible to breaking under pressure.", options: ["True", "False", "Can't tell"], correctAnswer: "B", explanation: "The correct answer is False. The passage says counterweights 'reduced the effective load by as much as 75%, greatly extending the operational lifespan of the bridge's hinges and axles,' not making them more susceptible." },
            { passageIndex: 2, text: "Contemporary beliefs about the strength of a raised drawbridge often exaggerated its true defensive value.", options: ["True", "False", "Can't tell"], correctAnswer: "A", explanation: "The correct answer is True. The passage notes, 'This perception may have exaggerated the military effectiveness of the mechanism far beyond its actual strength.'" },
            // Passage 4 Questions
            { passageIndex: 3, text: "The author is most likely to agree that:", options: ["The government does not care about women rights and domestic violence.", "That men are disenchanted with feminist movements.", "Systemic solutions to preventing domestic violence are more effective than treating the harms caused by it.", "The protest was unsuccessful."], correctAnswer: "C", explanation: "The correct answer is C. Sarah Williams is quoted saying, 'We need to be able to stop it before it starts,' and calls for 'more funding for primary prevention,' aligning with the idea that systemic, preventative solutions are key." },
            { passageIndex: 3, text: "According to the passage, why did Williams call for more men to be part of the protests?", options: ["Because it would encourage more men to listen to the issue of domestic violence.", "So that men could be held more accountable during the protest.", "Because it would provide a powerful symbol of men and women working together under the umbrella of feminism.", "To give their protest more logos and validity."], correctAnswer: "A", explanation: "The correct answer is A. Williams stated, '\"Men listen to men we need more male role models out there,\"' directly implying that male involvement helps the message reach other men." },
            { passageIndex: 3, text: "Which of the following matches the impact of the recent \"federal election campaign\" on the protests?", options: ["Its lack of discussion surrounding domestic violence deflated \"The No More\" rally.", "It reinforced the feeling of disenchantment among women at the rally with the government, making them more passionate.", "The positive changes mentioned encouraged women to come out in support of the government.", "It made the rally a political campaign stunt rather than an actually meaningful event."], correctAnswer: "B", explanation: "The correct answer is B. The passage states, 'Advocates say the issue was not properly addressed during the federal election campaign, with funding pledges \"barely even hitting the sides\".' This suggests the campaign's shortcomings likely fueled the protesters' resolve and highlighted their disenchantment." },
            { passageIndex: 3, text: "It can be implied that:", options: ["The issue of domestic violence is an unchanging one that has not improved over the last few centuries.", "The 128 women killed since January 2024 died due to avoidable causes.", "The government is working closely with those dealing directly with the issue to seek out new solutions.", "Action, rather than discussion, is the key for change here."], correctAnswer: "B", explanation: "The correct answer is B. The calls for 'determined action,' 'more funding, training, and law reform,' and specific preventative measures suggest that the deaths are viewed as resulting from systemic failures and are therefore avoidable with the right interventions." },
        ];


        // --- State ---
        let currentQuestionIndex = 0;
        let userAnswers = new Array(questions.length).fill(null);
        let timerInterval;
        let timeLeft = 10 * 60; // 10 minutes in seconds for 16 questions
        let examStartTime;
        let examEndTime;
        let userName = '';
        let userGoal = '';
        let userFocusArea = '';
        let isReviewingFromResults = false;
        let questionStartTime = null;
        let questionTimes = new Array(questions.length).fill(0);
        let flaggedQuestions = new Array(questions.length).fill(false);
        let isFilteringFlagged = false;
        let currentlyDisplayedPassageIndex = -1;


        // --- Elements ---
        const appContainer = document.getElementById('app-container');
        const setupScreen = document.getElementById('setup-screen');
        const examScreen = document.getElementById('exam-screen');
        const reviewScreen = document.getElementById('review-screen');
        const resultsScreen = document.getElementById('results-screen');
        const navigatorModal = document.getElementById('navigator-modal');
        const startButton = document.getElementById('start-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const navigatorButton = document.getElementById('navigator-button');
        const closeModalButton = document.getElementById('close-modal-button');
        const endExamButton = document.getElementById('end-exam-button'); 
        const endExamButtonFooter = document.getElementById('end-exam-button-footer'); 
        const backToResultsButton = document.getElementById('back-to-results-button');
        const flagButton = document.getElementById('flag-button');
        const passageNumberEl = document.getElementById('passage-number');
        const passageTextEl = document.getElementById('passage-text');
        const questionNumberEl = document.getElementById('question-number');
        const questionNumberInfoEl = document.getElementById('question-number-info');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        const reviewGrid = document.getElementById('review-grid');
        const navigatorGrid = document.getElementById('navigator-grid');
        const scoreEl = document.getElementById('score');
        const totalQuestionsResultsEl = document.getElementById('total-questions-results');
        const timeTakenEl = document.getElementById('time-taken');
        const resultsGridContainer = document.getElementById('results-grid-container'); // Changed from resultsDetails
        const nameInput = document.getElementById('name');
        const goalInput = document.getElementById('goal');
        const focusAreaInput = document.getElementById('focus-area');
        const examTitleEl = document.getElementById('exam-title');
        const filterFlaggedButton = document.getElementById('filter-flagged-button');
        const setupQuestionCountEl = document.getElementById('setup-question-count');
        const setupTimeLimitEl = document.getElementById('setup-time-limit');
        const reviewExplanationContainer = document.getElementById('review-explanation-container');
        const reflectionText = document.getElementById('reflection-text');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const focusRatingInput = document.getElementById('focus-rating');



        // --- Functions ---

        function startTimer() {
            examStartTime = new Date();
            clearInterval(timerInterval);
            timerEl.textContent = formatTimeSeconds(timeLeft);
            timerEl.classList.remove('text-gray-300'); 
            timerEl.classList.add('text-white', 'bg-opacity-20', 'bg-white');
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTimeSeconds(timeLeft);
                if (timeLeft <= 0) {
                    endExamAndShowResults();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            examEndTime = examEndTime || new Date(); 
            timerEl.classList.remove('text-white', 'bg-opacity-20', 'bg-white');
            timerEl.classList.add('text-gray-300'); 
        }

        function formatTimeSeconds(totalSeconds) {
             if (totalSeconds < 0) totalSeconds = 0; 
             const minutes = Math.floor(totalSeconds / 60);
             const seconds = totalSeconds % 60;
             return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function formatTimeDifference(milliseconds) {
            if (!milliseconds || milliseconds < 0) return "0 min 00 sec";
            const totalSeconds = Math.round(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
        }

        
        function recordTimeSpent(index) {
            if (questionStartTime && index >= 0 && index < questions.length) {
                const timeSpent = Date.now() - questionStartTime;
                questionTimes[index] = (questionTimes[index] || 0) + timeSpent; 
            }
            questionStartTime = null; 
        }

        
        function toggleFlag() {
            if (isReviewingFromResults) return; 
            const index = currentQuestionIndex;
            flaggedQuestions[index] = !flaggedQuestions[index];
            updateFlagButtonAppearance();
            updateNavigatorButtons(); 
        }

        
        function updateFlagButtonAppearance() {
            const isFlagged = flaggedQuestions[currentQuestionIndex];
            flagButton.textContent = isFlagged ? 'Unflag' : 'Flag for Review';
            flagButton.classList.toggle('flagged', isFlagged);
        }


        function loadQuestion(index, reviewMode = false) {
            if (index < 0 || index >= questions.length) return;

             
             if (!isReviewingFromResults && !reviewMode) { 
                 recordTimeSpent(currentQuestionIndex);
            }

            const question = questions[index];
            const newPassageIndex = question.passageIndex;
            const passageContainer = document.querySelector('.passage-column');
            const questionContainer = document.querySelector('.question-column');

            
            if (newPassageIndex !== currentlyDisplayedPassageIndex || reviewMode) {
                passageTextEl.innerHTML = passages[newPassageIndex].replace(/\n/g, '<br><br>');
                passageNumberEl.textContent = newPassageIndex + 1;
                currentlyDisplayedPassageIndex = newPassageIndex;
                 if (passageContainer) passageContainer.scrollTop = 0; 
            }

            currentQuestionIndex = index;
            isReviewingFromResults = reviewMode; 

            questionNumberEl.textContent = index + 1;
            questionNumberInfoEl.textContent = `${index + 1} of ${questions.length}`;
            questionTextEl.textContent = question.text;
             if (questionContainer) questionContainer.scrollTop = 0; 

            optionsContainer.innerHTML = '';
            reviewExplanationContainer.innerHTML = ''; 
            const optionLetters = ['A', 'B', 'C', 'D', 'E']; 
            question.options.forEach((option, i) => {
                const optionId = `q${index}_opt${i}`;
                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.classList.add('option-label');
                label.dataset.optionIndex = i; 

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.id = optionId;
                radio.name = `question_${index}`;
                radio.value = optionLetters[i]; 
                radio.disabled = reviewMode; 

                
                label.classList.remove('border-green-500', 'border-red-500', 'border-2', 'bg-green-50', 'bg-red-50', 'selected-answer');
                label.style.cursor = reviewMode ? 'default' : 'pointer';


                if (userAnswers[index] === optionLetters[i]) {
                    radio.checked = true;
                    label.classList.add('selected-answer');
                }

                
                if (reviewMode) {
                    const isCorrectAnswer = question.correctAnswer === optionLetters[i];
                    const isSelectedAnswer = userAnswers[index] === optionLetters[i];

                    if (isCorrectAnswer) {
                        label.classList.add('border-green-500', 'border-2'); 
                        if (!isSelectedAnswer) label.classList.add('bg-green-50'); 
                    } else if (isSelectedAnswer) { 
                        label.classList.add('border-red-500', 'border-2', 'bg-red-50');
                    }
                }

                label.appendChild(radio);
                const textNode = document.createTextNode(`${optionLetters[i]}) ${option}`);
                label.appendChild(textNode);

                if (!reviewMode) {
                    label.addEventListener('click', (e) => {
                        
                        if (e.target.tagName !== 'INPUT') {
                            handleOptionSelect(index, i, optionLetters[i]);
                        }
                    });
                    radio.addEventListener('change', () => handleOptionSelect(index, i, optionLetters[i]));
                }
                optionsContainer.appendChild(label);
            });

            
            if (reviewMode && question.explanation) {
                const explanationDiv = document.createElement('div');
                explanationDiv.classList.add('explanation-box'); 
                explanationDiv.innerHTML = `<strong class="font-semibold">Explanation:</strong> ${question.explanation}`;
                reviewExplanationContainer.appendChild(explanationDiv);
            }
            


            prevButton.disabled = index === 0;
            if (!reviewMode && index === questions.length - 1) { 
                 nextButton.textContent = 'Finish & Review';
                 nextButton.disabled = false;
            } else if (!reviewMode) { 
                 nextButton.textContent = 'Next (Alt+N) →';
                 nextButton.disabled = false;
            } else { 
                 nextButton.disabled = index === questions.length - 1;
                 if (!nextButton.disabled) nextButton.textContent = 'Next →'; 
            }

            updateFlagButtonAppearance();

            
            if (reviewMode) {
                backToResultsButton.classList.remove('hidden');
                endExamButtonFooter.classList.add('hidden');
                examTitleEl.textContent = "Reviewing Question";
                prevButton.disabled = index === 0; 
                navigatorButton.disabled = false; 
                flagButton.disabled = true; 
            } else { 
                backToResultsButton.classList.add('hidden');
                endExamButtonFooter.classList.remove('hidden');
                examTitleEl.textContent = "Verbal Reasoning";
                navigatorButton.disabled = false;
                flagButton.disabled = false;
                prevButton.disabled = index === 0;
            }

            updateNavigatorHighlight(); 

            
            if (!isReviewingFromResults) { 
                questionStartTime = Date.now();
            }
        }

         function handleOptionSelect(questionIndex, optionIndex, optionValue) {
             
             if (questionIndex !== currentQuestionIndex || isReviewingFromResults) return;
             userAnswers[questionIndex] = optionValue;

             
             document.querySelectorAll(`#options-container .option-label`).forEach(lbl => {
                 lbl.classList.remove('selected-answer');
                 const radio = lbl.querySelector('input[type="radio"]');
                 if(radio) radio.checked = false; 
             });

             const selectedLabel = document.querySelector(`#options-container label[for="q${questionIndex}_opt${optionIndex}"]`);
              if (selectedLabel) {
                 selectedLabel.classList.add('selected-answer');
                 const radio = selectedLabel.querySelector('input[type="radio"]');
                 if (radio) radio.checked = true; 
             }
             updateNavigatorButtons(); 
         }


        function showNextQuestion() {
            if (isReviewingFromResults) { 
                if (currentQuestionIndex < questions.length - 1) {
                    loadQuestion(currentQuestionIndex + 1, true); 
                }
            }
            else if (!isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 if (currentQuestionIndex === questions.length - 1) { 
                     stopTimer(); 
                     showReviewScreen(); 
                 } else if (currentQuestionIndex < questions.length - 1) {
                     loadQuestion(currentQuestionIndex + 1); 
                 }
            }
        }


        function showPrevQuestion() {
             if (isReviewingFromResults) { 
                 if (currentQuestionIndex > 0) {
                     loadQuestion(currentQuestionIndex - 1, true); 
                 }
             }
            else if (currentQuestionIndex > 0 && !isReviewingFromResults) { 
                 recordTimeSpent(currentQuestionIndex); 
                 loadQuestion(currentQuestionIndex - 1);
            }
        }

        function showSetupScreen() {
            setupScreen.classList.remove('hidden');
            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.remove('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
            
            if (setupQuestionCountEl) setupQuestionCountEl.textContent = questions.length;
            if (setupTimeLimitEl) setupTimeLimitEl.textContent = `${Math.floor(timeLeft / 60)} minutes`;

        }

        function showExamScreen() {
            setupScreen.classList.add('hidden');
            examScreen.classList.remove('hidden');
            examScreen.classList.add('flex'); 
            reviewScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col'); 
            currentlyDisplayedPassageIndex = -1; 
        }


        function showReviewScreen(filterFlagged = false) {
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.remove('hidden');
            reviewScreen.classList.add('flex');
            resultsScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            reviewGrid.innerHTML = ''; 
            questions.forEach((_, index) => {
                 if (filterFlagged && !flaggedQuestions[index]) { 
                     return;
                 }

                const button = document.createElement('button');
                button.textContent = index + 1;
                button.className = 'review-grid-button'; 

                if (userAnswers[index] !== null && userAnswers[index] !== undefined) {
                    button.classList.add('review-grid-button-answered');
                } else {
                     button.classList.add('review-grid-button-unanswered');
                }

                if (flaggedQuestions[index]) {
                    button.classList.add('review-flagged'); 
                }

                button.onclick = () => {
                    reviewScreen.classList.add('hidden'); 
                    reviewScreen.classList.remove('flex');
                    showExamScreen(); 
                    loadQuestion(index); 
                    startTimer(); 
                };
                reviewGrid.appendChild(button);
            });

             filterFlaggedButton.textContent = filterFlagged ? 'Show All Questions' : 'Show Flagged Only';
        }

         function populateNavigator() {
             navigatorGrid.innerHTML = ''; 
             questions.forEach((_, index) => {
                 const button = document.createElement('button');
                 button.textContent = index + 1;
                 
                 button.classList.add('py-2', 'px-1', 'border', 'border-gray-300', 'rounded-md', 'text-center', 'transition', 'duration-150', 'ease-in-out', 'text-sm', 'hover:bg-gray-100');
                 button.dataset.questionIndex = index; 

                 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');

                 button.onclick = () => {
                     navigatorModal.classList.remove('flex'); 
                     navigatorModal.classList.add('hidden');
                     const targetIndex = parseInt(button.dataset.questionIndex, 10);
                     
                     loadQuestion(targetIndex, isReviewingFromResults);
                     if (!isReviewingFromResults) questionStartTime = Date.now(); 
                 };
                 navigatorGrid.appendChild(button);
             });
         }

        function updateNavigatorButtons() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-answered', 'nav-current', 'nav-flagged'); 
                 if (userAnswers[index]) button.classList.add('nav-answered');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
                 if (flaggedQuestions[index]) button.classList.add('nav-flagged');
             });
        }

         function updateNavigatorHighlight() {
             if (!navigatorGrid) return;
             const buttons = navigatorGrid.querySelectorAll('button');
             buttons.forEach(button => {
                 const index = parseInt(button.dataset.questionIndex, 10);
                 button.classList.remove('nav-current');
                 if (index === currentQuestionIndex) button.classList.add('nav-current');
             });
         }

        function showResultsScreen() {
            examEndTime = examEndTime || new Date(); 
            recordTimeSpent(currentQuestionIndex); 
            stopTimer(); 

            examScreen.classList.add('hidden');
            reviewScreen.classList.add('hidden');
            reviewScreen.classList.remove('flex');
            resultsScreen.classList.remove('hidden');
            resultsScreen.classList.add('flex');
            setupScreen.classList.add('hidden');
            appContainer.classList.add('flex', 'flex-col');

            let score = 0;
            resultsGridContainer.innerHTML = ''; // Clear previous results grid

            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                if (isCorrect) score++;

                const timeSpentMs = questionTimes[index] || 0; 
                const timeSpentSec = Math.round(timeSpentMs / 1000);

                // Create the result box
                const resultBox = document.createElement('div');
                resultBox.classList.add('result-box');
                resultBox.classList.add(isCorrect ? 'result-box-correct' : 'result-box-incorrect');
                if (flaggedQuestions[index]) {
                    resultBox.classList.add('result-box-flagged');
                }
                resultBox.dataset.index = index; 
                resultBox.title = `Click to review Question ${index + 1}`;

                // Time spent display
                const timeDiv = document.createElement('div');
                timeDiv.classList.add('time-spent');
                timeDiv.textContent = `${timeSpentSec}s`;
                resultBox.appendChild(timeDiv);

                // Question number display
                const qNumDiv = document.createElement('div');
                qNumDiv.classList.add('question-num-label');
                qNumDiv.textContent = `Q${index + 1}`;
                resultBox.appendChild(qNumDiv);
                
                resultBox.addEventListener('click', () => {
                    revisitQuestionFromResults(index);
                });
                resultsGridContainer.appendChild(resultBox);
            });

            scoreEl.textContent = score;
            totalQuestionsResultsEl.textContent = questions.length;
            const timeDiff = examEndTime - examStartTime;
            timeTakenEl.textContent = formatTimeDifference(timeDiff);
        }


        function revisitQuestionFromResults(index) {
            resultsScreen.classList.add('hidden');
            resultsScreen.classList.remove('flex');
            showExamScreen();
            loadQuestion(index, true); 
        }

        function endExamAndShowResults() {
            stopTimer(); 
            showResultsScreen();
        }
         function handleEndExamFooterClick() {
             recordTimeSpent(currentQuestionIndex); 
             stopTimer();
             showReviewScreen(); 
         }

        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const reflection = reflectionText.value.trim();
            const focusRating = focusRatingInput.value; 
            const finalScore = scoreEl.textContent;
            const totalQ = totalQuestionsResultsEl.textContent; 
            const timeTaken = timeTakenEl.textContent;

            let y = 15; 
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 15;
            const pageWidth = doc.internal.pageSize.width;


            
            doc.setFontSize(18);
            doc.text("UCAT Verbal Reasoning Results", pageWidth / 2, y, { align: 'center' });
            y += lineHeight * 2;

            
            doc.setFontSize(12);
            const summaryData = [
                ["Name:", userName || 'N/A'],
                ["Goal:", `${userGoal || 'N/A'} / ${totalQ}`],
                ["Focus Area:", userFocusArea || 'N/A'],
                ["Final Score:", `${finalScore} / ${totalQ}`],
                ["Time Taken:", timeTaken],
                ["Focus Rating (1-5):", focusRating || 'N/A']
            ];

            summaryData.forEach(row => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.setFont(undefined, 'bold');
                doc.text(row[0], margin, y);
                doc.setFont(undefined, 'normal');
                doc.text(row[1], margin + 40, y);
                y += lineHeight;
            });
            y += lineHeight; 

            
            if (y > pageHeight - margin - (lineHeight*3)) { doc.addPage(); y = margin; } 
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Main Takeaway:", margin, y);
            y += lineHeight;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const reflectionLines = doc.splitTextToSize(reflection || 'No reflection provided.', pageWidth - margin * 2);
            reflectionLines.forEach(line => {
                if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                doc.text(line, margin, y);
                y += (lineHeight * 0.8);
            });
            y += lineHeight; 

            
            if (y > pageHeight - margin - (lineHeight*2)) { doc.addPage(); y = margin; }
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Detailed Results:", margin, y);
            y += lineHeight * 1.5;
            doc.setFontSize(9); 
            doc.setFont(undefined, 'normal');

            
            questions.forEach((qData, index) => {
                const userAnswer = userAnswers[index];
                const correctAnswer = qData.correctAnswer;
                const isCorrect = userAnswer !== null && userAnswer !== undefined && userAnswer === correctAnswer;
                const status = isCorrect ? "Correct" : (userAnswer ? "Incorrect" : "Not Answered");
                const timeSpentSec = Math.round((questionTimes[index] || 0) / 1000);

                const questionDetails = [
                    `Q${index + 1}: ${qData.text.substring(0, 60)}...${flaggedQuestions[index] ? ' (Flagged)' : ''}`,
                    `  Your Answer: ${userAnswer || 'N/A'}`,
                    `  Correct Answer: ${correctAnswer}`,
                    `  Status: ${status}`,
                    `  Time: ${timeSpentSec}s`
                ];

                
                const blockHeight = questionDetails.length * (lineHeight * 0.75) + (qData.explanation ? 3 * (lineHeight*0.75) : 0);
                if (y + blockHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin; 
                    
                    doc.setFontSize(14); doc.setFont(undefined, 'bold');
                    doc.text("Detailed Results (Continued):", margin, y);
                    y += lineHeight * 1.5;
                    doc.setFontSize(9); doc.setFont(undefined, 'normal');
                }

                questionDetails.forEach(detailLine => {
                    doc.text(detailLine, margin, y);
                    y += (lineHeight * 0.75);
                });

                if (qData.explanation) {
                    const explLines = doc.splitTextToSize(`  Explanation: ${qData.explanation}`, pageWidth - (margin * 2.5)); 
                    explLines.forEach(explLine => {
                         if (y > pageHeight - margin - lineHeight) { doc.addPage(); y = margin; }
                         doc.text(explLine, margin + 5, y); 
                         y += (lineHeight * 0.75);
                    });
                }
                y += (lineHeight * 0.5); 
            });

            doc.save(`ucat_vr_results_${userName.replace(/\s+/g, '_') || 'user'}.pdf`);
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            userName = nameInput.value.trim();
            userGoal = goalInput.value.trim();
            userFocusArea = focusAreaInput.value.trim();

            
            timeLeft = 10 * 60; 
            userAnswers = new Array(questions.length).fill(null);
            questionTimes = new Array(questions.length).fill(0);
            flaggedQuestions = new Array(questions.length).fill(false);
            questionStartTime = null;
            currentQuestionIndex = 0;
            isReviewingFromResults = false;
            isFilteringFlagged = false; 
            currentlyDisplayedPassageIndex = -1; 

            showExamScreen();
            startTimer(); 
            loadQuestion(0);
            populateNavigator(); 
        });

        nextButton.addEventListener('click', showNextQuestion);
        prevButton.addEventListener('click', showPrevQuestion);
        endExamButton.addEventListener('click', endExamAndShowResults); 
        endExamButtonFooter.addEventListener('click', handleEndExamFooterClick); 
        backToResultsButton.addEventListener('click', () => {
            isReviewingFromResults = false; 
            showResultsScreen(); 
        });
        navigatorButton.addEventListener('click', () => {
             recordTimeSpent(currentQuestionIndex); 
            updateNavigatorButtons(); 
            navigatorModal.classList.remove('hidden');
            navigatorModal.classList.add('flex');
        });
        closeModalButton.addEventListener('click', () => {
             navigatorModal.classList.remove('flex');
             navigatorModal.classList.add('hidden');
             if (!isReviewingFromResults) questionStartTime = Date.now(); 
        });
        
        navigatorModal.addEventListener('click', (event) => {
            if (event.target === navigatorModal) closeModalButton.click();
        });

        flagButton.addEventListener('click', toggleFlag);

        filterFlaggedButton.addEventListener('click', () => {
            isFilteringFlagged = !isFilteringFlagged;
            showReviewScreen(isFilteringFlagged); 
        });

        
        downloadPdfButton.addEventListener('click', generatePDF);


        
        function handleKeyboardShortcuts(e) {
             const isExamVisible = !examScreen.classList.contains('hidden');
             const isModalVisible = navigatorModal.classList.contains('flex');
             
             const isInputFocused = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA');

             if (isModalVisible || isInputFocused) return; 
             if (!isExamVisible) return; 

             const key = e.key.toLowerCase();
             const altOrOption = e.altKey; 
             const code = e.code.toLowerCase(); 

             if (altOrOption) {
                 switch (code) { 
                     case 'keyn': 
                         e.preventDefault();
                         if (!nextButton.disabled) nextButton.click();
                         return;
                     case 'keyp': 
                         e.preventDefault();
                         if (!prevButton.disabled) prevButton.click();
                         return;
                     case 'keyf': 
                         e.preventDefault();
                         if (!isReviewingFromResults && !flagButton.disabled) flagButton.click();
                         return;
                     default:
                         return; 
                 }
             } else { 
                 
                 if (['a', 'b', 'c', 'd'].includes(key) && !isReviewingFromResults) {
                     e.preventDefault();
                     const optionIndex = ['a', 'b', 'c', 'd'].indexOf(key);
                     const optionValue = ['A', 'B', 'C', 'D'][optionIndex];
                     const currentQuestionData = questions[currentQuestionIndex];
                     if (optionIndex < currentQuestionData.options.length) { 
                         handleOptionSelect(currentQuestionIndex, optionIndex, optionValue);
                     }
                     return;
                 }
             }
        }

        document.addEventListener('keydown', handleKeyboardShortcuts);


        // --- Initial Load ---
        showSetupScreen(); // Start with the setup screen

    </script>
</body>
</html>
